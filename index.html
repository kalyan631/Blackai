<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI - KALYAN AI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        gemini: {
                            blue: '#1d4ed8', // Blue-700
                            light: '#f0f4f9',
                            dark: '#131314',
                            surface: '#1e1f20'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Markdown Styles */
        .prose pre { background-color: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .prose code { color: #2563eb; background-color: #eff6ff; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.875em; }
        .dark .prose code { color: #60a5fa; background-color: #1e293b; }
        .prose p { margin-bottom: 1rem; line-height: 1.6; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        
        /* Cursor Blinking */
        .typing-cursor::after {
            content: 'â–‹';
            animation: blink 1s step-start infinite;
            color: #2563eb;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* Loader */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; color: #4b5563; flex-direction: column;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e5e7eb;
            border-top: 4px solid #2563eb; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-white dark:bg-gemini-dark text-gray-800 dark:text-gray-200 transition-colors duration-200 h-dvh w-full overflow-hidden flex">

    <div id="loading">
        <div class="spinner"></div>
        <div>Initializing App...</div>
        <div style="font-size: 0.8rem; margin-top: 10px; color: #999;">(Click screen if stuck)</div>
    </div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-gray-50 dark:bg-gemini-surface transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col border-r border-gray-200 dark:border-gray-700 shadow-lg md:shadow-none md:static">
        
        <div class="p-4 flex items-center justify-between">
            <div onclick="createNewChat()" class="cursor-pointer flex items-center space-x-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-4 py-2 rounded-full w-full hover:shadow-sm transition">
                <i class="fa-solid fa-plus"></i>
                <span class="font-medium text-sm">New Chat</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden ml-2 text-gray-500">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-2 space-y-1" id="chat-history-list">
            </div>

        <div class="p-4 border-t border-gray-200 dark:border-gray-700 space-y-2">
            <button onclick="openSettings()" class="flex items-center space-x-3 w-full p-2 text-sm hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition">
                <i class="fa-solid fa-gear"></i>
                <span>Settings</span>
            </button>
            <div class="flex items-center justify-between pt-2 text-xs text-gray-400">
                <span>Credit: Pari Kalyan</span>
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i id="theme-icon" class="fa-solid fa-moon"></i>
                </button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative w-full">
        
        <header class="flex items-center justify-between p-4 border-b border-gray-100 dark:border-gray-800 md:hidden bg-white dark:bg-gemini-dark z-20">
            <button onclick="toggleSidebar()" class="text-gray-600 dark:text-gray-300">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
            <span class="font-semibold text-lg text-gray-700 dark:text-gray-200">Gemini Clone</span>
            <div class="w-6"></div> </header>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-32 scroll-smooth">
            <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center opacity-100 transition-opacity">
                <div class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 bg-clip-text text-transparent mb-4">
                    Hello, Pari Kalyan
                </div>
                <p class="text-gray-500 dark:text-gray-400 text-lg">How can I help you today?</p>
            </div>
            
            </div>

        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-white via-white to-transparent dark:from-gemini-dark dark:via-gemini-dark pt-10 pb-4 px-4 md:px-20 z-10">
            <div class="max-w-4xl mx-auto relative bg-gray-100 dark:bg-gemini-surface rounded-3xl shadow-sm border border-transparent focus-within:border-gray-300 dark:focus-within:border-gray-600 transition-colors">
                <textarea 
                    id="user-input" 
                    rows="1" 
                    placeholder="Message Gemini..." 
                    class="w-full bg-transparent border-none focus:ring-0 p-4 pr-12 text-gray-800 dark:text-gray-100 resize-none max-h-48 overflow-y-auto"
                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                    onkeydown="handleEnter(event)"
                ></textarea>
                <button 
                    id="send-btn" 
                    onclick="sendMessage()"
                    class="absolute right-2 bottom-2 p-2 rounded-full text-gray-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-gray-700 transition"
                >
                    <i class="fa-solid fa-paper-plane text-lg"></i>
                </button>
            </div>
            <div class="text-center text-xs text-gray-400 mt-2">
                AI can make mistakes. Check important info.
            </div>
        </div>
    </main>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl transform scale-95 opacity-0 transition-all duration-200" id="settings-content">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold">Settings</h2>
                <button onclick="closeSettings()" class="text-gray-500 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-600 dark:text-gray-300">OpenRouter API Key</label>
                    <input type="password" id="api-key" placeholder="sk-or-..." class="w-full p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 outline-none">
                    <p class="text-xs text-gray-400 mt-1">Key is stored locally in your browser.</p>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-600 dark:text-gray-300">Model ID</label>
                    <input type="text" id="model-id" value="deepseek/deepseek-r1:free" class="w-full p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-600 dark:text-gray-300">System Prompt</label>
                    <textarea id="system-prompt" rows="3" class="w-full p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 outline-none resize-none" placeholder="You are a helpful AI..."></textarea>
                </div>
            </div>

            <div class="p-6 pt-0 flex justify-end">
                <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- SAFE LOADER REMOVAL (FIX) ---
        function hideLoader() {
            const loader = document.getElementById('loading');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }
        }
        
        // Force remove loader after 3 seconds if something fails
        setTimeout(hideLoader, 3000);
        
        // Also allow clicking the loader to dismiss it
        document.getElementById('loading').addEventListener('click', hideLoader);

        // --- STATE MANAGEMENT ---
        // Helper to safely parse JSON
        function safeJSONParse(key, fallback) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : fallback;
            } catch (e) {
                console.error("JSON Parse Error for", key, e);
                return fallback;
            }
        }

        const state = {
            chats: safeJSONParse('chats', {}),
            currentChatId: null,
            settings: {
                apiKey: localStorage.getItem('apiKey') || '',
                model: localStorage.getItem('model') || 'deepseek/deepseek-r1:free',
                systemPrompt: localStorage.getItem('systemPrompt') || 'You are a helpful AI assistant.',
                theme: localStorage.getItem('theme') || 'light'
            },
            isGenerating: false
        };

        // --- DOM ELEMENTS ---
        const els = {
            app: document.body,
            chatContainer: document.getElementById('chat-container'),
            input: document.getElementById('user-input'),
            sidebar: document.getElementById('sidebar'),
            historyList: document.getElementById('chat-history-list'),
            welcome: document.getElementById('welcome-screen'),
            settingsModal: document.getElementById('settings-modal'),
            settingsContent: document.getElementById('settings-content'),
            inputs: {
                key: document.getElementById('api-key'),
                model: document.getElementById('model-id'),
                system: document.getElementById('system-prompt')
            }
        };

        // --- INITIALIZATION ---
        function initApp() {
            try {
                applyTheme();
                renderHistory();
                
                const lastId = localStorage.getItem('lastChatId');
                if (lastId && state.chats[lastId]) {
                    loadChat(lastId);
                } else {
                    state.currentChatId = null;
                }
                
                // App is ready, hide loader
                hideLoader();
            } catch (error) {
                console.error("Init Error:", error);
                // Even if error, hide loader so user can see UI
                hideLoader();
            }
        }

        // Run Init
        window.addEventListener('DOMContentLoaded', initApp);

        // --- THEME ---
        function toggleTheme() {
            state.settings.theme = state.settings.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', state.settings.theme);
            applyTheme();
        }

        function applyTheme() {
            const isDark = state.settings.theme === 'dark';
            document.documentElement.classList.toggle('dark', isDark);
            document.getElementById('theme-icon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }

        // --- SIDEBAR ---
        function toggleSidebar() {
            els.sidebar.classList.toggle('-translate-x-full');
        }

        function renderHistory() {
            els.historyList.innerHTML = '';
            const sortedIds = Object.keys(state.chats).sort((a, b) => state.chats[b].timestamp - state.chats[a].timestamp);
            
            if (sortedIds.length === 0) {
                els.historyList.innerHTML = `<div class="p-4 text-center text-gray-400 text-sm">No chats yet</div>`;
                return;
            }

            sortedIds.forEach(id => {
                const chat = state.chats[id];
                const isActive = id === state.currentChatId;
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between p-2 rounded-lg text-sm cursor-pointer transition ${isActive ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300' : 'hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300'}`;
                div.onclick = () => loadChat(id);
                
                div.innerHTML = `
                    <div class="flex items-center space-x-2 truncate flex-1">
                        <i class="fa-regular fa-message text-xs opacity-70"></i>
                        <span class="truncate">${chat.title || 'New Chat'}</span>
                    </div>
                    <div class="hidden group-hover:flex space-x-1">
                        <button onclick="event.stopPropagation(); deleteChat('${id}')" class="p-1 hover:text-red-500"><i class="fa-solid fa-trash text-xs"></i></button>
                    </div>
                `;
                els.historyList.appendChild(div);
            });
        }

        // --- CHAT LOGIC ---
        function createNewChat() {
            state.currentChatId = null;
            els.chatContainer.innerHTML = '';
            els.chatContainer.appendChild(els.welcome);
            els.welcome.classList.remove('hidden');
            els.input.value = '';
            els.input.focus();
            if (window.innerWidth < 768) els.sidebar.classList.add('-translate-x-full'); 
            renderHistory();
        }

        function loadChat(id) {
            if (!state.chats[id]) return;
            state.currentChatId = id;
            localStorage.setItem('lastChatId', id);
            
            els.welcome.classList.add('hidden');
            els.chatContainer.innerHTML = '';
            
            state.chats[id].messages.forEach(msg => {
                appendMessageToDOM(msg.role, msg.content, false);
            });

            if (window.innerWidth < 768) els.sidebar.classList.add('-translate-x-full');
            renderHistory();
            scrollToBottom();
        }

        function deleteChat(id) {
            delete state.chats[id];
            localStorage.setItem('chats', JSON.stringify(state.chats));
            if (state.currentChatId === id) createNewChat();
            else renderHistory();
        }

        function scrollToBottom() {
            els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
        }

        // --- MESSAGING & API ---
        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const text = els.input.value.trim();
            if (!text || state.isGenerating) return;

            if (!state.settings.apiKey) {
                openSettings();
                alert('Please enter your OpenRouter API Key first.');
                return;
            }

            // UI Updates
            els.input.value = '';
            els.input.style.height = 'auto';
            els.welcome.classList.add('hidden');
            state.isGenerating = true;
            
            // 1. Initialize chat if new
            if (!state.currentChatId) {
                const id = Date.now().toString();
                state.currentChatId = id;
                state.chats[id] = {
                    id: id,
                    title: text.substring(0, 30) + '...',
                    timestamp: Date.now(),
                    messages: []
                };
            }

            // 2. Add User Message
            addMessage('user', text);

            // 3. Prepare AI Message Placeholder
            const aiMsgId = addMessage('assistant', '', true); // True = loading state

            // 4. Build Context
            const history = state.chats[state.currentChatId].messages.map(m => ({ role: m.role, content: m.content }));
            const messages = [
                { role: 'system', content: state.settings.systemPrompt },
                ...history
            ];

            // 5. Fetch & Stream
            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${state.settings.apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                        "X-Title": "Universal AI Clone"
                    },
                    body: JSON.stringify({
                        model: state.settings.model,
                        messages: messages,
                        stream: true
                    })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let aiResponse = "";
                const aiMsgEl = document.getElementById(aiMsgId);
                const contentEl = aiMsgEl.querySelector('.message-content');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split("\n");

                    for (const line of lines) {
                        if (line.startsWith("data: ")) {
                            const dataStr = line.replace("data: ", "").trim();
                            if (dataStr === "[DONE]") break;

                            try {
                                const data = JSON.parse(dataStr);
                                const delta = data.choices[0].delta.content || "";
                                aiResponse += delta;
                                
                                // Render markdown if available, else plain text
                                if (window.marked) {
                                    contentEl.innerHTML = marked.parse(aiResponse);
                                } else {
                                    contentEl.innerText = aiResponse;
                                }
                                scrollToBottom();
                            } catch (e) {
                                // Ignore parse errors for partial chunks
                            }
                        }
                    }
                }

                // Finalize
                state.chats[state.currentChatId].messages.push({ role: 'assistant', content: aiResponse });
                saveData();

            } catch (error) {
                const errMsgEl = document.getElementById(aiMsgId);
                if(errMsgEl) {
                    errMsgEl.querySelector('.message-content').innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
                }
            } finally {
                state.isGenerating = false;
                renderHistory(); // Update title order if needed
            }
        }

        function addMessage(role, content, isLoading = false) {
            // Save to state first (unless loading placeholder)
            if (!isLoading) {
                state.chats[state.currentChatId].messages.push({ role, content });
                saveData();
            }

            return appendMessageToDOM(role, content, isLoading);
        }

        function appendMessageToDOM(role, content, isLoading) {
            const msgId = `msg-${Date.now()}-${Math.random()}`;
            const isUser = role === 'user';
            
            const div = document.createElement('div');
            div.id = msgId;
            div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} mb-6`;
            
            const avatar = isUser 
                ? `<div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center ml-3"><i class="fa-solid fa-user text-gray-600"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-red-500 flex items-center justify-center mr-3"><i class="fa-solid fa-sparkles text-white text-xs"></i></div>`;

            const bubbleClass = isUser
                ? 'bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-tr-sm px-5 py-3 max-w-[85%] md:max-w-[70%]'
                : 'w-full max-w-[90%] md:max-w-[80%]';

            // Check if marked is loaded
            const parsedContent = (window.marked && !isUser && !isLoading) ? marked.parse(content) : content;

            const innerContent = isLoading 
                ? `<div class="message-content prose dark:prose-invert max-w-none"><i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i> Thinking...</div>` 
                : `<div class="message-content prose dark:prose-invert max-w-none text-sm md:text-base leading-relaxed ${isUser ? '' : 'typing-cursor'}">${isUser ? content : parsedContent}</div>`;

            div.innerHTML = isUser 
                ? `<div class="${bubbleClass}">${innerContent}</div>${avatar}`
                : `${avatar}<div class="${bubbleClass}">${innerContent}</div>`;

            els.chatContainer.appendChild(div);
            scrollToBottom();
            
            if (!isLoading && !isUser) {
                 setTimeout(() => {
                    const el = div.querySelector('.typing-cursor');
                    if(el) el.classList.remove('typing-cursor');
                 }, 100);
            }

            return msgId;
        }

        function saveData() {
            localStorage.setItem('chats', JSON.stringify(state.chats));
        }

        // --- SETTINGS ---
        function openSettings() {
            els.inputs.key.value = state.settings.apiKey;
            els.inputs.model.value = state.settings.model;
            els.inputs.system.value = state.settings.systemPrompt;
            els.settingsModal.classList.remove('hidden');
            setTimeout(() => {
                els.settingsContent.classList.remove('scale-95', 'opacity-0');
                els.settingsContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeSettings() {
            els.settingsContent.classList.remove('scale-100', 'opacity-100');
            els.settingsContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => els.settingsModal.classList.add('hidden'), 200);
        }

        function saveSettings() {
            state.settings.apiKey = els.inputs.key.value.trim();
            state.settings.model = els.inputs.model.value.trim();
            state.settings.systemPrompt = els.inputs.system.value.trim();
            
            localStorage.setItem('apiKey', state.settings.apiKey);
            localStorage.setItem('model', state.settings.model);
            localStorage.setItem('systemPrompt', state.settings.systemPrompt);
            closeSettings();
        }

        // Close modal on outside click
        els.settingsModal.addEventListener('click', (e) => {
            if (e.target === els.settingsModal) closeSettings();
        });
    </script>
</body>
</html>
